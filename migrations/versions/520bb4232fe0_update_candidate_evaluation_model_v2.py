"""update candidate evaluation model v2

Revision ID: 520bb4232fe0
Revises: 483ce2b9000b
Create Date: 2025-04-30 02:35:00.000000

"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision = '520bb4232fe0'
down_revision = '483ce2b9000b'
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    # First, add new columns as nullable
    op.add_column('candidate_evaluations', sa.Column('overall_score', sa.Float(), nullable=True))
    op.add_column('candidate_evaluations', sa.Column('skill_match', sa.Float(), nullable=True))
    op.add_column('candidate_evaluations', sa.Column('experience_match', sa.Float(), nullable=True))
    op.add_column('candidate_evaluations', sa.Column('matching_skills', postgresql.JSONB(astext_type=sa.Text()), nullable=True))
    
    # Copy data from old column to new columns
    op.execute("""
        UPDATE candidate_evaluations 
        SET overall_score = suitability_score,
            skill_match = suitability_score * 0.7,
            experience_match = suitability_score * 0.3,
            matching_skills = '[]'::jsonb
        WHERE suitability_score IS NOT NULL
    """)
    
    # Make new columns non-nullable
    op.alter_column('candidate_evaluations', 'overall_score', nullable=False)
    op.alter_column('candidate_evaluations', 'skill_match', nullable=False)
    op.alter_column('candidate_evaluations', 'experience_match', nullable=False)
    op.alter_column('candidate_evaluations', 'matching_skills', nullable=False, server_default='[]')
    
    # Drop old column
    op.drop_column('candidate_evaluations', 'suitability_score')
    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    # Add back old column
    op.add_column('candidate_evaluations', sa.Column('suitability_score', sa.Float(), nullable=True))
    
    # Copy data back to old column
    op.execute("""
        UPDATE candidate_evaluations 
        SET suitability_score = overall_score
        WHERE overall_score IS NOT NULL
    """)
    
    # Make old column non-nullable
    op.alter_column('candidate_evaluations', 'suitability_score', nullable=False)
    
    # Drop new columns
    op.drop_column('candidate_evaluations', 'matching_skills')
    op.drop_column('candidate_evaluations', 'experience_match')
    op.drop_column('candidate_evaluations', 'skill_match')
    op.drop_column('candidate_evaluations', 'overall_score')
    # ### end Alembic commands ### 